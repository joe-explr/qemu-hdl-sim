# Setting up QEMU 10.1.3
----------------------------
1. Install Dependencies:

    `zmq  v4.1.4` -> https://github.com/zeromq/libzmq/releases/download/v4.1.4/zeromq-4.1.4.tar.gz

    `czmq v4.0.2` -> https://github.com/zeromq/czmq/releases/download/v4.0.2/czmq-4.0.2.tar.gz

    `ncurses`
    
    On Ubuntu 16.04:
    `apt install libczmq-dev libzmq-dev libncurses5-dev`

2. Download QEMU 10.1.3

    ```
    wget https://download.qemu.org/qemu-10.1.3.tar.xz
    tar -xJf qemu-10.1.3.tar.xz
    ```

3. Apply the patch and create symbolic links

    ```
    patch -s -p0 < qemu-cosim.patch
    mkdir -p qemu-10.1.3/include/acc
    cd qemu-10.1.3/include/acc
    ln -s ../../../acc.h ./
    cd ../../hw/misc
    ln -s ../../../accelerator_pcie.c ./
    cd ../../../
    ```

4. Configure the PCIe pseudo device (not required anymore)

    ```
    cd qemu-10.1.3
    ```

    Modify `include/acc/acc.h` and `hw/misc/accelerator_pcie.c` if needed.

5. Configure and build 

    ```
    mkdir build
    cd build
    ../configure --target-list=x86_64-softmmu --enable-vnc --enable-sdl --enable-curses --enable-spice
    ```

    Add `-lzmq -lczmq` to `LIBS+` in `config-host.mak`

    ```  
    make -j8
    ```

5. Launching qemu with accelerator

    Sample launch script: 10g_launch.sh

    To launch qemu with the accelerator you must add the following flag: `-device accelerator-pcie`

    The device is a XILIX device and can be verified using `lspci -v` inside the guest os.


# Modifying Device Settings
----------------------------

### Current Device and Setup

The files relevant to the accelerator are:
`include/acc/acc.h`
`hw/misc/accelerator_pcie.c`

Currently the accelerator exposes 2 64-bit BAR regions. 
To change the sizes of these BAR regions you need to modify the value of the `REGION_SIZE_BAR?`, where `?` is the number associated with the BAR region.
The address translation is done on the HDL side. 
The offsets for each BAR is hardcoded in the device, these can be changed by modifying `REGION_OFFSET_BAR?`. 

Since address translation is done on the HDL side, it is important that the `REGION_OFFSET_BAR?` macros match the offsets on the address editor.

Currenty the accelerator has only 1 MSI interrupt vector enabled.
This can be changed by changing `NUM_MSI_VEC`. 

`NUM_MSI_VEC` and the `REGION_*` macros can be found in `include/acc/acc.h`.

### Adding New BAR Regions

If you wish to a new BAR regions you need to add new `MemoryRegion` field to `ACCPCIeState` struct. 
The new BAR needs a `MemoryRegionOps`.
This can created using the `MEM_REGION_OPS_BAR` macro.
This macro will create a `static const MemoryRegionOps` struct named `mmio_ops_bar?`. 
The new BAR region will also need read and write callbacks which can easily be generated by using the `MMIO_WRITE_BAR` and `MMIO_READ_BAR` macros.
These macros will create `mmio_read_bar?` and `mmio_write_bar?` functions respectively. 
It is critical that you have defined the `REGION_OFFSET_BAR?` macro corresponding to the BAR region as the read and write functions use this macro to transfer the corrrect address to HDL. 

`MEM_REGION_OPS_BAR` and the `MMIO_*` macros can be found in `hw/misc/accelerator_pcie.c`.

##### Initializing the BAR in `acc_pcie_realize` 

Each BAR region needs an initialized memory region. 
This is done by using the `memory_region_init_io` function provided by QEMU.

Finally the BAR region you are creating needs to be registered.
This is done by using the `pci_register_bar` function provided by QEMU.
A list of the available attributes for the BAR are:

```
    PCI_BASE_ADDRESS_SPACE_IO      0x01    /* 0 = memory, 1 = I/O */
    PCI_BASE_ADDRESS_SPACE_MEMORY  0x00
    PCI_BASE_ADDRESS_MEM_TYPE_32   0x00    /* 32 bit address */    
    PCI_BASE_ADDRESS_MEM_TYPE_64   0x04    /* 64 bit address */
    PCI_BASE_ADDRESS_MEM_PREFETCH  0x08    /* prefetchable? */
```

### Running multiple instances of the environment on the same machine

In order to run multiple instances of the environment on the same machine, the zmq sockets must have unique ports. 
This can be achieved by modifying the `*_REP` and `*_REQ` macros in `include/acc/acc.h`.

**Note about HDL**: The DPI code uses a symlinked `acc.h`.
This symlink points (should point) to `include/acc/acc.h`.
